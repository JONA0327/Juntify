<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Reproducci√≥n de Segmentos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }

        .test-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .audio-controls {
            margin: 20px 0;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 5px;
        }

        .segment-test {
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        .segment-buttons {
            margin-top: 10px;
        }

        .logs {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>üîß Test Reproducci√≥n de Segmentos de Audio</h1>

    <div class="status info">
        <strong>üéØ Objetivo:</strong> Verificar que la reproducci√≥n de segmentos por hablante funcione correctamente despu√©s de eliminar WebM.
    </div>

    <div class="test-section">
        <h3>1. Cargar Audio de Prueba</h3>
        <input type="file" id="audioFile" accept="audio/mp3,audio/mp4,audio/m4a" />
        <button onclick="loadTestAudio()">Cargar Audio</button>

        <div id="audioStatus" class="status info" style="display: none;">
            <strong>Estado:</strong> <span id="statusText">Esperando archivo...</span>
        </div>
    </div>

    <div class="audio-controls" id="audioControls" style="display: none;">
        <h3>2. Control de Audio Principal</h3>
        <audio id="recorded-audio" controls style="width: 100%; margin-bottom: 10px;"></audio>
        <div>
            <strong>Duraci√≥n:</strong> <span id="audioDuration">--:--</span> |
            <strong>Formato:</strong> <span id="audioFormat">--</span> |
            <strong>Tama√±o:</strong> <span id="audioSize">--</span>
        </div>
    </div>

    <div class="test-section" id="segmentTests" style="display: none;">
        <h3>3. Tests de Segmentos Simulados</h3>
        <p>Estos segmentos simulan la transcripci√≥n por hablantes:</p>

        <div class="segment-test">
            <strong>Hablante A (0:00 - 0:10)</strong>
            <div class="segment-buttons">
                <button onclick="playTestSegment(0, 10)">‚ñ∂Ô∏è Reproducir Segmento</button>
                <button onclick="pauseSegment()">‚è∏Ô∏è Pausar</button>
            </div>
        </div>

        <div class="segment-test">
            <strong>Hablante B (0:10 - 0:20)</strong>
            <div class="segment-buttons">
                <button onclick="playTestSegment(10, 20)">‚ñ∂Ô∏è Reproducir Segmento</button>
                <button onclick="pauseSegment()">‚è∏Ô∏è Pausar</button>
            </div>
        </div>

        <div class="segment-test">
            <strong>Hablante A (0:20 - 0:30)</strong>
            <div class="segment-buttons">
                <button onclick="playTestSegment(20, 30)">‚ñ∂Ô∏è Reproducir Segmento</button>
                <button onclick="pauseSegment()">‚è∏Ô∏è Pausar</button>
            </div>
        </div>

        <div class="segment-test">
            <strong>Test Largo - Hablante C (0:30 - 1:00)</strong>
            <div class="segment-buttons">
                <button onclick="playTestSegment(30, 60)">‚ñ∂Ô∏è Reproducir Segmento</button>
                <button onclick="pauseSegment()">‚è∏Ô∏è Pausar</button>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h3>4. Tests de Casos Edge</h3>
        <button onclick="testQuickSwitching()">Test Cambio R√°pido</button>
        <button onclick="testOverlapping()">Test Segmentos Superpuestos</button>
        <button onclick="testLongSegment()">Test Segmento Largo</button>
        <button onclick="clearLogs()">Limpiar Logs</button>
    </div>

    <div class="logs" id="debugLogs">
        <strong>Debug Logs:</strong><br>
        Esperando eventos...
    </div>

    <script>
        let audioPlayer = null;
        let audioData = null;
        let segmentEndHandler = null;
        let currentSegmentIndex = null;

        // Funciones helper (copiadas del sistema principal)
        function initializeAudioPlayer() {
            if (!audioPlayer) {
                audioPlayer = document.getElementById('recorded-audio');
            }

            if (!audioPlayer) {
                logDebug('‚ùå Audio player element not found');
                return false;
            }

            if (!audioPlayer.src && audioData) {
                try {
                    const src = typeof audioData === 'string' ? audioData : URL.createObjectURL(audioData);
                    audioPlayer.src = src;
                    logDebug('‚úÖ Audio source set successfully');
                } catch (error) {
                    logDebug('‚ùå Error setting audio source: ' + error.message);
                    return false;
                }
            }

            return true;
        }

        function waitForAudioReady(player, timeoutMs = 10000) {
            return new Promise((resolve, reject) => {
                if (player.readyState >= 2) {
                    resolve();
                    return;
                }

                const onCanPlay = () => {
                    player.removeEventListener('canplay', onCanPlay);
                    player.removeEventListener('canplaythrough', onCanPlayThrough);
                    player.removeEventListener('error', onError);
                    clearTimeout(timeoutId);
                    resolve();
                };

                const onCanPlayThrough = () => {
                    player.removeEventListener('canplay', onCanPlay);
                    player.removeEventListener('canplaythrough', onCanPlayThrough);
                    player.removeEventListener('error', onError);
                    clearTimeout(timeoutId);
                    resolve();
                };

                const onError = (error) => {
                    player.removeEventListener('canplay', onCanPlay);
                    player.removeEventListener('canplaythrough', onCanPlayThrough);
                    player.removeEventListener('error', onError);
                    clearTimeout(timeoutId);
                    reject(new Error('Error cargando el audio: ' + (error.message || 'Unknown error')));
                };

                player.addEventListener('canplay', onCanPlay);
                player.addEventListener('canplaythrough', onCanPlayThrough);
                player.addEventListener('error', onError);

                const timeoutId = setTimeout(() => {
                    player.removeEventListener('canplay', onCanPlay);
                    player.removeEventListener('canplaythrough', onCanPlayThrough);
                    player.removeEventListener('error', onError);
                    reject(new Error('Timeout: El audio est√° tardando mucho en cargar'));
                }, timeoutMs);

                if (player.networkState === HTMLMediaElement.NETWORK_EMPTY) {
                    player.load();
                }
            });
        }

        function logDebug(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logs = document.getElementById('debugLogs');
            logs.innerHTML += `<br>[${timestamp}] ${message}`;
            logs.scrollTop = logs.scrollHeight;
            console.log(`[TEST] ${message}`);
        }

        function loadTestAudio() {
            const fileInput = document.getElementById('audioFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('Por favor selecciona un archivo de audio');
                return;
            }

            logDebug(`üìÅ Cargando archivo: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`);

            // Verificar formato
            if (!file.type.includes('mp4') && !file.type.includes('mpeg') && !file.name.includes('.m4a') && !file.name.includes('.mp3')) {
                logDebug('‚ùå Formato no soportado: ' + file.type);
                alert('Solo se permiten archivos MP3 (.mp3) o MP4 (.m4a)');
                return;
            }

            audioData = file;
            const audioElement = document.getElementById('recorded-audio');
            const url = URL.createObjectURL(file);
            audioElement.src = url;

            // Actualizar informaci√≥n
            document.getElementById('audioFormat').textContent = file.type || 'Desconocido';
            document.getElementById('audioSize').textContent = (file.size/1024/1024).toFixed(2) + ' MB';

            audioElement.onloadedmetadata = () => {
                const duration = audioElement.duration;
                const minutes = Math.floor(duration / 60);
                const seconds = Math.floor(duration % 60);
                document.getElementById('audioDuration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                logDebug(`‚úÖ Audio cargado exitosamente - Duraci√≥n: ${minutes}:${seconds.toString().padStart(2, '0')}`);

                // Mostrar controles
                document.getElementById('audioStatus').style.display = 'block';
                document.getElementById('statusText').textContent = 'Audio cargado correctamente';
                document.getElementById('audioControls').style.display = 'block';
                document.getElementById('segmentTests').style.display = 'block';
            };

            audioElement.onerror = (error) => {
                logDebug('‚ùå Error cargando audio: ' + error);
                alert('Error cargando el archivo de audio');
            };
        }

        async function playTestSegment(startTime, endTime) {
            logDebug(`üéµ Iniciando reproducci√≥n de segmento: ${startTime}s - ${endTime}s`);

            if (!initializeAudioPlayer()) {
                alert('Error inicializando el reproductor de audio');
                return;
            }

            // Limpiar handler anterior
            if (segmentEndHandler) {
                audioPlayer.removeEventListener('timeupdate', segmentEndHandler);
                segmentEndHandler = null;
            }

            // Pausar si est√° reproduciendo
            if (!audioPlayer.paused) {
                audioPlayer.pause();
            }

            try {
                // Esperar a que el audio est√© listo
                await waitForAudioReady(audioPlayer, 15000);

                // Configurar el tiempo de inicio
                audioPlayer.currentTime = startTime;

                // Crear handler para detener al final del segmento
                segmentEndHandler = () => {
                    if (audioPlayer.currentTime >= endTime) {
                        audioPlayer.pause();
                        audioPlayer.removeEventListener('timeupdate', segmentEndHandler);
                        segmentEndHandler = null;
                        logDebug(`‚úÖ Segmento completado: ${startTime}s - ${endTime}s`);
                    }
                };

                audioPlayer.addEventListener('timeupdate', segmentEndHandler);

                // Intentar reproducir
                await audioPlayer.play();

                logDebug(`‚úÖ Reproduciendo segmento exitosamente: ${startTime}s - ${endTime}s`);

            } catch (error) {
                logDebug(`‚ùå Error reproduciendo segmento: ${error.message}`);

                // Limpiar handlers
                if (segmentEndHandler) {
                    audioPlayer.removeEventListener('timeupdate', segmentEndHandler);
                    segmentEndHandler = null;
                }

                alert('Error: ' + error.message);
            }
        }

        function pauseSegment() {
            if (audioPlayer && !audioPlayer.paused) {
                audioPlayer.pause();
                logDebug('‚è∏Ô∏è Segmento pausado manualmente');
            }

            if (segmentEndHandler) {
                audioPlayer.removeEventListener('timeupdate', segmentEndHandler);
                segmentEndHandler = null;
            }
        }

        function testQuickSwitching() {
            logDebug('üîÑ Iniciando test de cambio r√°pido...');
            playTestSegment(0, 5);
            setTimeout(() => playTestSegment(10, 15), 1000);
            setTimeout(() => playTestSegment(20, 25), 2000);
        }

        function testOverlapping() {
            logDebug('üîÑ Iniciando test de segmentos superpuestos...');
            playTestSegment(0, 15);
            setTimeout(() => playTestSegment(10, 20), 2000);
        }

        function testLongSegment() {
            logDebug('üîÑ Iniciando test de segmento largo...');
            if (audioPlayer && audioPlayer.duration > 60) {
                playTestSegment(0, 60);
            } else {
                playTestSegment(0, Math.min(30, audioPlayer?.duration || 30));
            }
        }

        function clearLogs() {
            document.getElementById('debugLogs').innerHTML = '<strong>Debug Logs:</strong><br>Logs limpiados...';
        }

        // Inicializaci√≥n
        window.addEventListener('load', () => {
            logDebug('üöÄ Test de reproducci√≥n de segmentos iniciado');
            logDebug('üìã Sistema configurado para MP4/MP3 exclusivamente');
        });
    </script>
</body>
</html>
